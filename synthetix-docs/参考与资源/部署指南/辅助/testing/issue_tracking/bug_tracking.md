# Triplex协议问题跟踪记录

## 问题跟踪总览

| 问题ID | 相关模块 | 问题描述 | 严重程度 | 状态 | 责任人 | 预计修复日期 |
|-------|---------|---------|---------|------|------|----------|
| BUG-001 | 预言机集成模块 | 多个预言机数据合并计算中位数时出现精度损失 | 高 | 未修复 | 王工 | 2023-07-22 |
| BUG-002 | 流动性池管理模块 | 移除流动性计算错误，用户无法取回全部资产 | 严重 | 未修复 | 张工 | 2023-07-21 |
| BUG-004 | 资金费率模块 | 资金费率结算金额不足，约4%的资金未正确转移 | 严重 | 未修复 | 赵工 | 2023-07-21 |
| BUG-005 | 清算机制模块 | 全仓清算后用户仍有剩余保证金 | 中等 | 未修复 | 李工 | 2023-07-23 |

## 问题详情

### BUG-001: 预言机数据合并精度问题

**模块**: 预言机集成模块
**严重程度**: 高
**状态**: 未修复
**发现日期**: 2023-07-12
**责任人**: 王工
**预计修复日期**: 2023-07-22

#### 问题描述
在聚合多个预言机数据并计算中位数价格时，由于使用了整数除法，导致精度损失。特别是当预言机数量为偶数时，中位数计算不准确，最终价格偏离实际市场价格。

#### 重现步骤
1. 配置4个预言机价格源（ETH价格为：30000, 30100, 30200, 30300）
2. 调用 `get_aggregated_price` 函数获取聚合价格
3. 观察返回的中位数价格

#### 影响范围
影响所有依赖预言机数据的交易定价和清算评估，可能导致错误的交易执行和不必要的清算。

#### 修复方案
1. 修改 `oracle.move` 中的 `calculate_median` 函数，使用定点数计算替代整数除法
2. 增加小数位精度，确保计算中不丢失有效数字
3. 添加异常价格过滤机制，剔除明显偏离的价格数据

#### 修复进度
- [ ] 代码修改
- [ ] 单元测试
- [ ] 代码审查
- [ ] 集成测试
- [ ] 修复确认

### BUG-002: 流动性池移除计算错误

**模块**: 流动性池管理模块
**严重程度**: 严重
**状态**: 未修复
**发现日期**: 2023-07-14
**责任人**: 张工
**预计修复日期**: 2023-07-21

#### 问题描述
流动性池中的 `remove_liquidity` 函数在计算用户应返还的资产金额时，使用了错误的计算公式。导致用户在移除流动性时，只能取回约95%的应得资产，其余5%仍锁定在合约中。

#### 重现步骤
1. 用户向流动性池提供1000 USDC和0.5 ETH的流动性
2. 获得LP代币
3. 用户尝试移除全部流动性
4. 检查返还的资产数量

#### 影响范围
直接影响用户的资产安全，可能导致用户资金损失和信任降低。

#### 修复方案
1. 重新审核并更正 `pool.move` 文件中的 `calculate_removed_amounts` 函数的计算公式
2. 更新相关的测试用例，确保不同比例的流动性移除都能正确计算
3. 添加审计检查，确保资产平衡

#### 修复进度
- [ ] 代码修改
- [ ] 单元测试
- [ ] 代码审查
- [ ] 集成测试
- [ ] 修复确认

### BUG-004: 资金费率结算金额不足

**模块**: 资金费率模块
**严重程度**: 严重
**状态**: 未修复
**发现日期**: 2023-07-16
**责任人**: 赵工
**预计修复日期**: 2023-07-21

#### 问题描述
在资金费率结算过程中，实际转移的资金金额少于应有金额。多头用户支付金额应为20 USDC，但实际只支付了19.2 USDC(96%)；空头用户应收取16 USDC，但实际只收到了15.36 USDC(96%)。这表明在资金费结算计算中有约4%的资金被错误扣除。

#### 重现步骤
1. 设置ETH市场价格高于指数价格2%
2. 计算资金费率为+0.02%
3. 设置多头用户A仓位100ETH，空头用户B仓位80ETH
4. 执行资金费率结算
5. 检查用户余额变化

#### 影响范围
影响交易双方的资金平衡，长期运行可能造成系统资金缺口。

#### 修复方案
1. 检查 `funding.move` 文件的 `calculate_funding_payment` 函数中的计算逻辑
2. 修复 `transfer_funding_payment` 函数中可能存在的手续费扣除逻辑
3. 添加资金流向的审计日志，确保每笔资金都能正确追踪

#### 修复进度
- [ ] 代码修改
- [ ] 单元测试
- [ ] 代码审查
- [ ] 集成测试
- [ ] 修复确认

### BUG-005: 全仓清算保证金残留

**模块**: 清算机制模块
**严重程度**: 中等
**状态**: 未修复
**发现日期**: 2023-07-18
**责任人**: 李工
**预计修复日期**: 2023-07-23

#### 问题描述
在全仓清算过程中，用户的所有仓位被清算后，理论上剩余保证金应该为0或者全部转给清算人作为奖励。但测试发现用户C在全仓清算后仍有2.5 USDC的保证金，这不符合全仓清算的设计预期。

#### 重现步骤
1. 设置用户C健康因子为0.1（保证金20 USDC，借款200 USDC）
2. 执行全仓清算
3. 检查用户C的剩余保证金和债务

#### 影响范围
影响清算过程的完整性和系统资金平衡，可能造成资金账目不平。

#### 修复方案
1. 检查 `liquidation.move` 文件的 `distribute_remaining_collateral` 函数中的保证金处理逻辑
2. 增加清算后的资产检查，确保全仓清算后用户保证金为0
3. 完善清算事件记录，包含详细的资金流向信息

#### 修复进度
- [ ] 代码修改
- [ ] 单元测试
- [ ] 代码审查
- [ ] 集成测试
- [ ] 修复确认

## 问题修复优先级

1. **最高优先级**:
   - BUG-002: 流动性池移除计算错误（直接影响用户资产安全）
   - BUG-004: 资金费率结算金额不足（影响系统资金平衡）

2. **高优先级**:
   - BUG-001: 预言机数据合并精度问题（影响交易定价准确性）

3. **中等优先级**:
   - BUG-005: 全仓清算保证金残留（影响系统完整性）

## 问题修复流程

1. **问题确认**：验证问题存在并确定根本原因
2. **方案设计**：设计解决方案并进行代码审查
3. **代码实现**：修改代码实现解决方案
4. **单元测试**：编写或更新单元测试验证修复
5. **代码审查**：团队成员进行代码审查
6. **集成测试**：在测试环境中进行集成测试
7. **修复确认**：确认问题已解决并不会引入新问题
8. **文档更新**：更新相关文档反映修复情况

## 问题修复会议安排

- **每日进度同步会**：每天上午10:00
- **代码审查会议**：每天下午16:00
- **修复方案讨论会**：每周一、三、五 14:00

## 问题修复后续跟踪

为防止类似问题再次发生，修复后需要：

1. 完善自动化测试用例，覆盖更多边界条件
2. 更新开发文档，详细说明各功能模块的实现细节和注意事项
3. 建立代码审查清单，重点关注计算精度、资金处理和安全检查
4. 定期进行全面测试，确保系统稳定运行

---

*文档更新日期：2023-07-19*
*文档版本：v1.0* 