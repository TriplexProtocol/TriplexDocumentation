# Triplex协议集成测试计划

## 概述

本文档描述了Triplex协议的集成测试计划，主要关注系统中各模块之间的交互和整体功能的验证。集成测试将确保不同模块能够正确协同工作，整个系统能够实现预期的业务流程。

## 测试范围

集成测试将覆盖以下核心功能模块之间的交互：

1. **预言机集成** - 为系统提供价格数据
2. **债务报告系统** - 管理用户债务和抵押品状态
3. **流动性池管理** - 提供市场流动性
4. **资金费率模块** - 处理持仓资金费率计算和结算
5. **清算机制模块** - 执行风险账户的清算

## 测试环境

与单元测试相同，但需要完整的系统部署。

## 集成测试场景

### 场景一：价格更新与债务健康度

**测试用例ID**：IC-001

**测试目标**：验证预言机价格更新后，系统能正确计算债务健康度并触发清算条件

**测试步骤**：
1. 初始化预言机系统并注册ETH/USDC预言机
2. 用户创建债务报告，借入10000 USDC并抵押1 ETH
3. 初始ETH价格设为12000 USDC，验证账户健康度良好
4. 将ETH价格更新为10500 USDC
5. 验证债务健康度重新计算
6. 确认清算条件被触发

**预期结果**：
- 当ETH价格下降到10500 USDC后，用户账户抵押率降至105%
- 系统成功识别抵押率低于110%的清算阈值
- 相关事件正确触发

### 场景二：完整资金费率周期

**测试用例ID**：IC-002

**测试目标**：验证资金费率从计算到结算的完整流程

**测试步骤**：
1. 初始化预言机系统和资金费率系统
2. 创建BTC永续合约市场，设置初始资金费率参数
3. 多个用户开设不同方向的仓位（多头和空头）
4. 通过预言机更新价格数据
5. 系统计算资金费率
6. 触发资金费率结算
7. 验证用户余额变动情况

**预期结果**：
- 系统根据市场价格和指数价格差异正确计算资金费率
- 资金费率结算时，多头向空头（或空头向多头，取决于费率方向）正确转移资金
- 资金费率记录被正确保存

### 场景三：清算流程端到端测试

**测试用例ID**：IC-003

**测试目标**：验证从债务创建到清算的完整流程

**测试步骤**：
1. 初始化所有相关系统（预言机、债务报告、清算机制）
2. 用户创建债务报告，借入资产并提供抵押品
3. 通过预言机更新价格，使抵押品价值下降
4. 系统识别账户可清算状态
5. 清算人执行清算操作
6. 验证债务清偿和抵押品分配结果

**预期结果**：
- 系统正确识别可清算账户
- 清算流程顺利执行完成
- 债务被清偿，抵押品根据清算规则正确分配
- A账户接收清算奖励

### 场景四：流动性池与交易执行

**测试用例ID**：IC-004

**测试目标**：验证流动性池能否支持用户交易执行

**测试步骤**：
1. 初始化流动性池系统
2. 管理员创建流动性池
3. 流动性提供者向池中提供流动性
4. 用户执行交易（开仓/平仓）
5. 验证交易执行结果和流动性变化

**预期结果**：
- 用户交易能够成功执行
- 流动性池余额正确变动
- 相关手续费正确计算和分配

### 场景五：紧急情况处理流程

**测试用例ID**：IC-005

**测试目标**：验证系统在紧急情况下的处理流程

**测试步骤**：
1. 初始化所有系统
2. 模拟预言机价格异常（价格剧烈波动或预言机失效）
3. 管理员启动紧急暂停程序
4. 验证系统各功能暂停状态
5. 管理员恢复系统
6. 验证系统恢复后的功能可用性

**预期结果**：
- 系统成功进入暂停状态
- 暂停期间，用户交易和关键操作被阻止
- 系统恢复后，功能正常运行

## 具体集成测试用例

### 1. 预言机与清算机制集成测试

#### 测试用例：IC-101

| 字段 | 描述 |
|-----|-----|
| 测试用例ID | IC-101 |
| 测试名称 | 验证预言机价格变动触发清算 |
| 测试优先级 | 高 |
| 测试前置条件 | 1. 预言机系统已初始化<br>2. 清算系统已初始化<br>3. 用户已创建债务报告 |
| 测试步骤 | 1. 设置初始ETH价格为12000 USDC<br>2. 用户借入10000 USDC，抵押1 ETH<br>3. 更新ETH价格为10500 USDC<br>4. 系统检查账户抵押率<br>5. 清算人执行清算 |
| 预期结果 | 1. 价格更新后抵押率为105%<br>2. 系统标记账户为可清算<br>3. 清算执行成功<br>4. 抵押品按清算规则分配 |
| 测试数据 | 用户：0xUSER1<br>债务：10000 USDC<br>抵押品：1 ETH<br>初始价格：12000 USDC/ETH<br>更新价格：10500 USDC/ETH |
| 测试脚本 | `integration_tests/oracle_liquidation_integration_test.move` |

### 2. 资金费率与预言机集成测试

#### 测试用例：IC-201

| 字段 | 描述 |
|-----|-----|
| 测试用例ID | IC-201 |
| 测试名称 | 验证预言机价格用于资金费率计算 |
| 测试优先级 | 高 |
| 测试前置条件 | 1. 预言机系统已初始化<br>2. 资金费率系统已初始化<br>3. 永续合约市场已创建 |
| 测试步骤 | 1. 设置预言机指数价格为30000 USDC/BTC<br>2. 设置市场价格为30500 USDC/BTC<br>3. 触发资金费率计算<br>4. 验证资金费率结果 |
| 预期结果 | 1. 系统成功获取预言机价格数据<br>2. 正确计算价格偏差为+1.67%<br>3. 资金费率计算为+0.0167%（使用0.01乘数）<br>4. 资金费率记录正确存储 |
| 测试数据 | 市场：BTC-PERP<br>指数价格：30000 USDC/BTC<br>市场价格：30500 USDC/BTC<br>资金费率乘数：0.01 |
| 测试脚本 | `integration_tests/oracle_funding_rate_integration_test.move` |

### 3. 债务系统与清算机制集成测试

#### 测试用例：IC-301

| 字段 | 描述 |
|-----|-----|
| 测试用例ID | IC-301 |
| 测试名称 | 验证债务系统与清算机制的协同工作 |
| 测试优先级 | 高 |
| 测试前置条件 | 1. 债务报告系统已初始化<br>2. 清算系统已初始化<br>3. 预言机系统已初始化 |
| 测试步骤 | 1. 用户创建债务报告<br>2. 设置抵押品价格使账户进入可清算状态<br>3. 执行清算<br>4. 验证债务报告状态变更 |
| 预期结果 | 1. 债务报告状态从"活跃"变更为"已清算"<br>2. 债务金额正确更新<br>3. 抵押品数量正确扣减<br>4. 清算事件正确记录 |
| 测试数据 | 用户：0xUSER2<br>债务：5000 USDC<br>初始抵押品：0.5 ETH<br>清算后债务：0 USDC<br>清算后抵押品：0 ETH |
| 测试脚本 | `integration_tests/debt_liquidation_integration_test.move` |

### 4. 流动性池与资金费率集成测试

#### 测试用例：IC-401

| 字段 | 描述 |
|-----|-----|
| 测试用例ID | IC-401 |
| 测试名称 | 验证流动性池支持资金费率结算 |
| 测试优先级 | 中 |
| 测试前置条件 | 1. 流动性池系统已初始化<br>2. 资金费率系统已初始化<br>3. 有多头和空头持仓用户 |
| 测试步骤 | 1. 设置正资金费率（多头支付空头）<br>2. 触发资金费率结算<br>3. 验证资金从多头流向空头<br>4. 验证流动性池余额变动 |
| 预期结果 | 1. 资金费率正确结算<br>2. 用户余额正确变动<br>3. 流动性池相关手续费正确累计 |
| 测试数据 | 多头用户：0xLONG1, 持仓：10 BTC<br>空头用户：0xSHORT1, 持仓：-8 BTC<br>资金费率：+0.01% |
| 测试脚本 | `integration_tests/liquidity_funding_rate_integration_test.move` |

### 5. 全流程端到端测试

#### 测试用例：IC-501

| 字段 | 描述 |
|-----|-----|
| 测试用例ID | IC-501 |
| 测试名称 | 完整交易生命周期测试 |
| 测试优先级 | 高 |
| 测试前置条件 | 所有系统模块已初始化 |
| 测试步骤 | 1. 创建流动性池<br>2. 添加流动性<br>3. 用户开设交易仓位<br>4. 更新预言机价格<br>5. 计算并结算资金费率<br>6. 用户平仓<br>7. 验证整个流程的结果 |
| 预期结果 | 1. 仓位正确创建<br>2. 资金费率正确计算和结算<br>3. 平仓操作成功执行<br>4. 用户盈亏正确计算<br>5. 流动性池余额正确变动 |
| 测试数据 | 用户：0xUSER3<br>交易对：ETH-PERP<br>仓位大小：2 ETH<br>方向：多头<br>杠杆倍数：10x |
| 测试脚本 | `integration_tests/end_to_end_trading_test.move` |

## 测试优先级和执行顺序

1. 先执行关键模块间的集成测试（IC-101, IC-201, IC-301）
2. 执行功能流程测试（IC-401）
3. 最后执行端到端测试（IC-501）

## 测试依赖关系

1. 所有集成测试依赖于单元测试的成功执行
2. 端到端测试依赖于各模块间集成测试的成功执行

## 测试结果记录

集成测试结果将记录在以下文件中：
- `integration_test_results.md`

## 测试时间表

| 阶段 | 开始日期 | 结束日期 | 负责人 |
|-----|---------|---------|-------|
| 集成测试环境准备 | 2023-07-23 | 2023-07-24 | 测试团队 |
| 模块间集成测试 | 2023-07-25 | 2023-07-27 | 王工、李工 |
| 端到端测试 | 2023-07-28 | 2023-07-29 | 张工 |
| 问题修复与回归测试 | 2023-07-30 | 2023-08-01 | 所有人 |
| 集成测试报告 | 2023-08-02 | 2023-08-03 | 测试负责人 |

## 风险与缓解措施

| 风险 | 可能性 | 影响 | 缓解措施 |
|-----|--------|-----|---------|
| 模块间接口不兼容 | 中 | 高 | 预先审查接口文档，确保接口一致性 |
| 集成环境配置问题 | 中 | 中 | 准备详细的环境配置文档，进行预验证 |
| 测试数据不一致 | 低 | 高 | 建立统一的测试数据管理策略 |
| 性能瓶颈 | 中 | 中 | 进行预先的性能评估，准备扩展方案 |

---

*计划编制日期：2023-07-05*
*计划版本：v1.0* 