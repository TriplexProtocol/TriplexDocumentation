# 资金费率模块测试结果报告

## 测试概述

- **测试日期**：2023-07-16
- **测试版本**：v0.1.0
- **测试环境**：开发
- **测试执行人**：赵工

## 测试用例执行结果汇总

| 测试用例ID | 测试名称 | 优先级 | 执行结果 | 备注 |
|-----------|---------|-------|---------|------|
| TC-FR-001 | 验证资金费率系统初始化 | 高 | 通过 | 初始化正常 |
| TC-FR-101 | 验证设置资金费率周期 | 高 | 通过 | 设置功能正常 |
| TC-FR-201 | 验证资金费率计算 | 高 | 通过 | 计算逻辑正确 |
| TC-FR-301 | 验证资金费率结算 | 高 | 失败 | 结算金额不足 |
| TC-FR-401 | 验证资金费率历史记录 | 高 | 通过 | 记录功能正常 |

**测试通过率**：80% (4 / 5)

## 详细测试结果

### 测试用例：TC-FR-001

#### 基本信息
- **测试用例ID**：TC-FR-001
- **测试名称**：验证资金费率系统初始化
- **测试执行时间**：2023-07-16 09:30

#### 执行步骤与结果

| 步骤 | 预期结果 | 实际结果 | 状态 |
|-----|---------|---------|------|
| 1. 部署资金费率模块 | 部署成功 | 部署成功 | 通过 |
| 2. 执行系统初始化函数 | 初始化成功，返回初始化完成事件 | 初始化成功，事件正确触发 | 通过 |
| 3. 检查初始化后的系统状态 | 全局设置已初始化，默认周期为1小时 | 初始化成功，周期设置正确 | 通过 |

#### 测试截图/日志
```
[debug] 执行资金费率系统初始化
[info] 创建资金费率配置
[info] 设置默认结算周期: 3600秒
[info] 触发FundingRateSystemInitialized事件
[info] 初始化完成
```

#### 问题描述
无

#### 修复建议
无

### 测试用例：TC-FR-101

#### 基本信息
- **测试用例ID**：TC-FR-101
- **测试名称**：验证设置资金费率周期
- **测试执行时间**：2023-07-16 10:45

#### 执行步骤与结果

| 步骤 | 预期结果 | 实际结果 | 状态 |
|-----|---------|---------|------|
| 1. 管理员修改资金费率周期为8小时 | 修改成功 | 修改成功 | 通过 |
| 2. 普通用户尝试修改周期 | 操作被拒绝，权限错误 | 操作被拒绝，返回权限错误 | 通过 |
| 3. 查询当前周期配置 | 周期为8小时(28800秒) | 周期为8小时(28800秒) | 通过 |

#### 测试截图/日志
```
[debug] 管理员修改资金费率周期为: 28800秒
[info] 周期修改成功
[debug] 普通用户尝试修改周期
[error] 权限错误: 只有管理员可以设置资金费率周期
[debug] 查询当前周期配置
[info] 当前周期: 28800秒 (8小时)
```

#### 问题描述
无

#### 修复建议
无

### 测试用例：TC-FR-301

#### 基本信息
- **测试用例ID**：TC-FR-301
- **测试名称**：验证资金费率结算
- **测试执行时间**：2023-07-16 15:30

#### 执行步骤与结果

| 步骤 | 预期结果 | 实际结果 | 状态 |
|-----|---------|---------|------|
| 1. 设置市场价格高于指数价格 | 设置成功，差异为+2% | 设置成功，差异为+2% | 通过 |
| 2. 计算资金费率 | 资金费率为+0.02% | 资金费率为+0.02% | 通过 |
| 3. 多头用户A仓位100ETH，空头用户B仓位80ETH | A支付，B收取 | A支付不足，B收取不足 | 失败 |
| 4. 验证结算后的余额变化 | A: -20 USDC, B: +16 USDC | A: -19.2 USDC, B: +15.36 USDC | 失败 |

#### 测试截图/日志
```
[debug] 设置ETH市场价格: 30600 USDC
[debug] 设置ETH指数价格: 30000 USDC
[info] 价格差异: +2.00%
[debug] 计算资金费率: +0.02%
[debug] 多头用户A仓位: 100 ETH
[debug] 空头用户B仓位: 80 ETH
[debug] 执行资金费率结算
[warning] 用户A应支付: 20 USDC, 实际支付: 19.2 USDC
[warning] 用户B应收取: 16 USDC, 实际收取: 15.36 USDC
[error] 结算金额不足: 4% 的资金未正确结算
```

#### 问题描述
在资金费率结算过程中，实际转移的资金金额少于应有金额。多头用户支付金额应为20 USDC，但实际只支付了19.2 USDC(96%)；空头用户应收取16 USDC，但实际只收到了15.36 USDC(96%)。这表明在资金费结算计算中有约4%的资金被错误扣除。

#### 修复建议
检查 `settle_funding_rate` 函数中的资金计算和转移逻辑，特别是是否有未考虑到的手续费或舍入问题。此外，需要确认是否有中间过程扣除了额外费用。问题可能在 `funding.move` 文件的 `calculate_funding_payment` 或 `transfer_funding_payment` 函数中。

## 发现的问题汇总

| 问题ID | 相关测试用例 | 问题描述 | 严重程度 | 状态 |
|-------|------------|---------|---------|------|
| BUG-004 | TC-FR-301 | 资金费率结算金额不足，约4%的资金未正确转移 | 严重 | 未修复 |

## 测试覆盖率分析

| 模块 | 行覆盖率 | 函数覆盖率 | 分支覆盖率 |
|-----|---------|----------|----------|
| funding_rate.move | 94% | 100% | 92% |
| funding_rate_calculation.move | 96% | 100% | 94% |
| funding_rate_history.move | 90% | 100% | 85% |
| **总体覆盖率** | **93%** | **100%** | **90%** |

## 测试结论与建议

### 测试结论
资金费率模块的基本功能大部分正常，包括系统初始化、周期设置、费率计算和历史记录。主要问题在于资金费率结算功能，结算时有约4%的资金未能正确转移，这会导致多头和空头用户的资金不平衡，长期运行可能造成系统资金缺口，需要优先修复。

### 改进建议
1. 修复资金费率结算金额计算逻辑，确保资金完整转移
2. 增加资金费率结算的审计机制，确保每次结算多空双方的资金平衡
3. 考虑在结算过程中添加详细日志，便于追踪资金流向
4. 添加极端价格波动情况下的资金费率上限控制，防止过大的资金转移

## 附录

### 测试环境详情
- **硬件配置**：8核CPU, 16GB内存, 512GB SSD
- **软件版本**：Ubuntu 20.04 LTS, Aptos Framework v1.2.0, Move编译器v1.5.0
- **网络环境**：本地开发网络

### 测试数据
- ETH市场价格: 30600 USDC
- ETH指数价格: 30000 USDC
- 价格差异: +2.00%
- 资金费率: +0.02%
- 资金费率周期: 8小时
- 多头仓位: 100 ETH
- 空头仓位: 80 ETH

---

*报告生成日期：2023-07-16*
*报告版本：v1.0* 