# triplex 架构设计

## 整体架构

triplex 协议采用模块化设计，基于 Aptos 区块链的 Move 编程语言实现。其架构设计充分利用了 Move 的资源模型和 Aptos 的账户模型，形成一个由多个核心模块组成的综合性金融协议。

![Triplex架构图](../../../assets/triplex-architecture.png)

### 分层架构

triplex 采用以下分层架构：

1. **基础层**：提供通用工具、账户管理和事件定义
2. **资产层**：定义和管理各种合成资产
3. **金库层**：实现资产锁定和收益分配功能
4. **预言机层**：集成外部价格数据
5. **资金池层**：管理协议流动性和资金分配
6. **接口层**：提供与其他模块和用户的交互接口

### 设计原则

triplex 的架构遵循以下关键设计原则：

- **资源安全**：利用 Move 的资源模型确保资产完整性和安全性
- **模块化**：功能解耦为独立模块，便于维护和升级
- **可扩展性**：支持添加新的合成资产和功能模块
- **互操作性**：与其他 Aptos 协议和跨链桥接组件兼容
- **账户中心**：基于 Aptos 的账户模型设计存储和操作

## 核心模块

### 1. accounts 模块

账户模块负责用户账户的创建、验证和管理，是用户与协议交互的基础。

**主要组件**：
- `Account` 结构：表示用户账户
- 账户初始化功能
- 身份验证机制
- 权限控制

**关键接口**：
- `create_account`：创建新账户
- `register_account`：注册账户到协议
- `verify_account`：验证账户权限

### 2. asset 模块

资产模块定义了协议中的各种合成资产，包括原生代币和合成代币。

**主要组件**：
- `Asset` 基础结构：定义资产通用属性
- 各种合成资产实现（BTC、ETH、黄金等）
- 资产铸造和销毁机制
- 价格追踪逻辑

**关键接口**：
- `mint`：铸造新资产
- `burn`：销毁资产
- `transfer`：转移资产
- `get_price`：获取资产价格

### 3. vault 模块

金库模块允许用户锁定资产以参与协议和获取奖励。

**主要组件**：
- `Vault` 结构：表示用户金库
- 存款和取款机制
- 收益计算和分配
- 清算处理

**关键接口**：
- `create_vault`：创建新金库
- `deposit`：存入资产
- `withdraw`：提取资产
- `claim_rewards`：领取奖励

### 4. oracle 模块

预言机模块与 Pyth Network 集成，为协议提供外部资产价格数据。

**主要组件**：
- `PriceOracle` 接口
- 价格数据验证机制
- 价格更新和缓存
- 多资产价格支持

**关键接口**：
- `get_price`：获取资产价格
- `update_price`：更新价格数据
- `validate_price`：验证价格数据

### 5. treasury 模块

资金池模块管理协议的流动性和资金分配。

**主要组件**：
- `TreasuryPool` 结构
- 资金储备管理
- 费用收集和分配
- 流动性管理

**关键接口**：
- `collect_fees`：收集交易费用
- `distribute_funds`：分配资金
- `manage_reserves`：管理储备金

## 数据流

以下是 triplex 协议中主要操作的数据流：

### 铸造合成资产流程

1. 用户通过 `account` 模块验证身份
2. 从 `oracle` 模块获取目标资产当前价格
3. 用户提供抵押品给 `asset` 模块
4. `asset` 模块铸造合成资产
5. 根据铸造金额向 `treasury` 模块支付费用
6. 合成资产转移到用户账户

```
用户 -> 账户验证 -> 获取价格 -> 提供抵押品 -> 铸造资产 -> 支付费用 -> 资产到账
```

### 金库存款流程

1. 用户通过 `account` 模块验证身份
2. 用户选择要存入的资产和金库类型
3. `vault` 模块验证存款条件
4. 资产从用户账户转移到金库
5. 更新用户在金库中的余额和收益信息

```
用户 -> 账户验证 -> 选择资产和金库 -> 验证条件 -> 资产转移 -> 更新余额
```

### 价格更新流程

1. `keeper` 服务触发价格更新
2. 从 Pyth Network 获取最新价格数据
3. `oracle` 模块验证价格数据有效性
4. 将验证后的价格数据更新到链上
5. 发出价格更新事件

```
Keeper -> 获取外部价格 -> 验证数据 -> 更新链上价格 -> 发出事件
```

## 设计模式

triplex 实现了多种设计模式以确保系统的可维护性、安全性和可扩展性：

### 1. 资源模式
利用 Move 的资源类型确保资产不能被复制或隐式丢弃，只能转移，保障资产安全。

```move
struct Asset has key, store {
    value: u64
}
```

### 2. 能力模式
使用 Move 的能力系统控制对资源的操作权限，确保只有授权操作可以执行。

```move
public(friend) fun mint(account: &signer, amount: u64) {
    // 只有友元模块可以调用
}
```

### 3. 模块化模式
将功能拆分为独立的模块，每个模块负责特定功能，促进代码重用和维护。

### 4. 代理调用模式
某些操作需要用户授权，通过 `signer` 参数实现代理调用模式。

```move
public fun deposit(account: &signer, vault_id: VaultID, asset: Asset) {
    // 用户授权操作
}
```

### 5. 事件发布模式
重要状态变更时发布事件，便于链下服务跟踪和反应。

```move
struct MintEvent has drop, store {
    amount: u64,
    asset_type: u8,
}

public fun emit_mint_event(amount: u64, asset_type: u8) {
    event::emit(MintEvent { amount, asset_type });
}
```

### 6. 接口分离模式
将接口和实现分离，允许多种实现同一接口。例如，价格预言机接口可以有多种实现。

## 与以太坊版本的架构比较

triplex 协议架构与以太坊上的 Synthetix 有以下主要区别：

### 存储模型
- **Synthetix (以太坊)**：使用合约存储映射管理用户资产和状态
- **triplex (Aptos)**：直接在用户账户存储中管理资产和状态

### 资产实现
- **Synthetix**：使用 ERC-20 标准实现合成资产
- **triplex**：使用 Move 资源模型实现合成资产，资源直接存储在用户账户中

### 模块化方式
- **Synthetix**：使用合约继承和代理模式实现升级和模块化
- **triplex**：使用 Move 的原生模块化和直接升级能力

### 并发处理
- **Synthetix**：单线程执行，需要显式处理重入攻击
- **triplex**：支持并发交易处理，Move 的类型系统原生防止重入

### 升级机制
- **Synthetix**：通过代理合约模式实现升级
- **triplex**：使用 Aptos 的直接模块升级机制

## 未来架构演进

triplex 协议计划的架构演进包括：

1. **多链支持**：扩展架构以支持多链部署和跨链操作
2. **分片扩展**：优化存储和计算以支持更大规模的用户和资产
3. **治理集成**：添加更完善的链上治理系统
4. **可组合性增强**：提高与其他 DeFi 协议的可组合性
5. **Layer 2 扩展**：与 Aptos 的 Layer 2 解决方案集成以进一步提升可扩展性 